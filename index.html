<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        #wrap {
            width: 800px;
            height: 400px;
            position: relative;
        }
        #wrap > canvas:not([id]) {
            z-index: 2;
        }
        #wrap > canvas {
            position: absolute;
            left: 0;
            top: 0;
        }
        #draw {
            z-index: 1;
        }
        #save {
            width: 400px;
        }
        #save .wrap {
            position: relative;
            width: 100%;
        }
        #save > div {
            position: relative;
        }
        #save .item {
            position: absolute;
            left: 0;
            top: 0;
        }
        #save .trigger {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="wrap">
        <canvas id="draw" width="800" height="400"></canvas>
        <canvas id="road" width="800" height="400"></canvas>
        <canvas id="background" width="800" height="400"></canvas>
    </div>
    <select id="name">
        <option value="red">A1</option>
        <option value="orange">A2</option>
        <option value="blue">A3</option>
    </select>
    <button id="saveButton">저장</button>
    <div id="save">
    </div>
    <script
    src="https://code.jquery.com/jquery-3.4.1.js"
    integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
    crossorigin="anonymous"></script>
    <script
    src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"
    integrity="sha256-T0Vest3yCU7pafRw9r+settMBX6JkKN06dqBnpQ8d30="
    crossorigin="anonymous"></script>
    <script>

    Object.prototype.deepCopy = function() {
        return JSON.parse(JSON.stringify(this));
    };

    var currentMap = {
        road: [
		    [1, 19], [2, 19], [3, 19], [4, 19], [5, 19], [6, 19], [7, 19], [8, 19], [9, 19], [10, 19], [11, 19], [12, 19], [13, 19], [14, 19], [15, 19], [16, 19], [17, 19], [18, 19], [19, 19], [20, 19], [21, 19], [22, 19], [23, 19], [24, 19], [25, 19], [26, 19], [27, 19], [28, 19], [29, 19], [30, 19], [31, 19], [32, 19], [33, 19], [34, 19], [35, 19], [36, 19], [37, 19], [38, 19], [39, 19], [40, 19], [41, 19], [42, 19], [43, 19], [44, 19], [45, 19], [46, 19], [47, 19], [48, 19], [49, 19], [50, 19], [51, 19], [52, 19], [53, 19],
		    [1, 20], [2, 20], [3, 20], [4, 20], [5, 20], [6, 20], [7, 20], [8, 20], [9, 20], [10, 20], [11, 20], [12, 20], [13, 20], [14, 20], [15, 20], [16, 20], [17, 20], [18, 20], [19, 20], [20, 20], [21, 20], [22, 20], [23, 20], [24, 20], [25, 20], [26, 20], [27, 20], [28, 20], [29, 20], [30, 20], [31, 20], [32, 20], [33, 20], [34, 20], [35, 20], [36, 20], [37, 20], [38, 20], [39, 20], [40, 20], [41, 20], [42, 20], [43, 20], [44, 20], [45, 20], [46, 20], [47, 20], [48, 20], [49, 20], [50, 20], [51, 20], [52, 20], [53, 20],
		    [1, 21], [2, 21], [3, 21], [4, 21], [5, 21], [6, 21], [7, 21], [8, 21], [9, 21], [10, 21], [11, 21], [12, 21], [13, 21], [14, 21], [15, 21], [16, 21], [17, 21], [18, 21], [19, 21], [20, 21], [21, 21], [22, 21], [23, 21], [24, 21], [25, 21], [26, 21], [27, 21], [28, 21], [29, 21], [30, 21], [31, 21], [32, 21], [33, 21], [34, 21], [35, 21], [36, 21], [37, 21], [38, 21], [39, 21], [40, 21], [41, 21], [42, 21], [43, 21], [44, 21], [45, 21], [46, 21], [47, 21], [48, 21], [49, 21], [50, 21], [51, 21], [52, 21], [53, 21],
		    [1, 22], [2, 22], [3, 22], [4, 22], [5, 22], [6, 22], [7, 22], [8, 22], [9, 22], [10, 22], [11, 22], [12, 22], [13, 22], [14, 22], [15, 22], [16, 22], [17, 22], [18, 22], [19, 22], [20, 22], [21, 22], [22, 22], [23, 22], [24, 22], [25, 22], [26, 22], [27, 22], [28, 22], [29, 22], [30, 22], [31, 22], [32, 22], [33, 22], [34, 22], [35, 22], [36, 22], [37, 22], [38, 22], [39, 22], [40, 22], [41, 22], [42, 22], [43, 22], [44, 22], [45, 22], [46, 22], [47, 22], [48, 22], [49, 22], [50, 22], [51, 22], [52, 22], [53, 22],
		    [54, 1], [54, 2], [54, 3], [54, 4], [54, 5], [54, 6], [54, 7], [54, 8], [54, 9], [54, 10], [54, 11], [54, 12], [54, 13], [54, 14], [54, 15], [54, 16], [54, 17], [54, 18], [54, 19], [54, 20], [54, 21], [54, 22], [54, 23], [54, 24], [54, 25], [54, 26], [54, 27], [54, 28], [54, 29], [54, 30], [54, 31], [54, 32], [54, 33], [54, 34], [54, 35], [54, 36], [54, 37], [54, 38], [54, 39], [54, 40],
		    [55, 1], [55, 2], [55, 3], [55, 4], [55, 5], [55, 6], [55, 7], [55, 8], [55, 9], [55, 10], [55, 11], [55, 12], [55, 13], [55, 14], [55, 15], [55, 16], [55, 17], [55, 18], [55, 19], [55, 20], [55, 21], [55, 22], [55, 23], [55, 24], [55, 25], [55, 26], [55, 27], [55, 28], [55, 29], [55, 30], [55, 31], [55, 32], [55, 33], [55, 34], [55, 35], [55, 36], [55, 37], [55, 38], [55, 39], [55, 40],
		    [56, 1], [56, 2], [56, 3], [56, 4], [56, 5], [56, 6], [56, 7], [56, 8], [56, 9], [56, 10], [56, 11], [56, 12], [56, 13], [56, 14], [56, 15], [56, 16], [56, 17], [56, 18], [56, 19], [56, 20], [56, 21], [56, 22], [56, 23], [56, 24], [56, 25], [56, 26], [56, 27], [56, 28], [56, 29], [56, 30], [56, 31], [56, 32], [56, 33], [56, 34], [56, 35], [56, 36], [56, 37], [56, 38], [56, 39], [56, 40],
		    [57, 1], [57, 2], [57, 3], [57, 4], [57, 5], [57, 6], [57, 7], [57, 8], [57, 9], [57, 10], [57, 11], [57, 12], [57, 13], [57, 14], [57, 15], [57, 16], [57, 17], [57, 18], [57, 19], [57, 20], [57, 21], [57, 22], [57, 23], [57, 24], [57, 25], [57, 26], [57, 27], [57, 28], [57, 29], [57, 30], [57, 31], [57, 32], [57, 33], [57, 34], [57, 35], [57, 36], [57, 37], [57, 38], [57, 39], [57, 40]
        ],
        rooms: {

        },
    };
    var roads = [];
    var savedData = [];
    var options = {
        name: '',
        color: 'red',
    };
    
    var BackgroundCanvasManager = {
        create(canvas, rows, cols) {
            var ctx = canvas.getContext('2d');
            var width = canvas.width;
            var height = canvas.height;
            var columnWidth = width / cols;
            var columnHeight = height / rows;
            for (var i = 0; i < cols; i += 1) {
                ctx.beginPath();
                ctx.moveTo(columnWidth * i, 0);
                ctx.lineTo(columnWidth * i, height);
                ctx.strokeStyle = i % 2 ? 'black' : '#CCC';
                ctx.stroke();
                ctx.closePath();
            }
            for (var i = 0; i < rows; i += 1) {
                ctx.beginPath();
                ctx.moveTo(0, columnHeight * i);
                ctx.lineTo(width, columnHeight * i);
                ctx.strokeStyle = i % 2 ? 'black' : '#CCC';
                ctx.stroke();
                ctx.closePath();
            }
            return canvas;
        }
    };

    var DrawCanvasManager = {
        init(canvas, container, rows, cols) {
            var ctx = canvas.getContext('2d');
            var flag = false;
            var startX = startY = endX = endY = 0;
            var canvasWidth = canvas.width;
            var canvasHeight = canvas.height;
            var columnWidth = canvasWidth / cols;
            var columnHeight = canvasHeight / rows;
            canvas.addEventListener('mousedown', () => {
                flag = true;
                startX = Math.round(event.offsetX / columnWidth) + 1;
                startY = Math.round(event.offsetY / columnHeight) + 1;
            });
            canvas.addEventListener('mousemove', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (!flag) return;
                endX = Math.round(event.offsetX / columnWidth) + 1;
                endY = Math.round(event.offsetY / columnHeight) + 1;
                var width = (endX - startX) * columnWidth;
                var height = (endY - startY) * columnHeight;
                ctx.fillRect((startX - 1) * columnWidth, (startY - 1) * columnHeight, width, height);
            });
            canvas.addEventListener('mouseup', () => {
                flag = false;
                var temp;
                if (startX > endX) {
                    temp = startX;
                    startX = endX;
                    endX = temp;
                }
                if (startY > endY) {
                    temp = startY;
                    startY = endY;
                    endY = temp;
                }
                var color = options.color || 'red';
                var data = { startX, startY, endX, endY, color };
                currentMap.rooms[options.name] = data;
                this.clear(document.getElementById('wrap'));
                this.create(document.getElementById('wrap'), currentMap.rooms, canvasWidth, canvasHeight, 40, 80);
            });
        },
        create(container, rooms, width, height, rows, cols) {
            var columnWidth = width / cols;
            var columnHeight = height / rows;
            for (var key of Object.keys(rooms)) {
                var canvas = document.createElement('canvas');
                canvas.setAttribute('class', 'item');
                var ctx = canvas.getContext('2d');
                var item = rooms[key];
                var startX = (item.startX - 1) * columnWidth;
                var startY = (item.startY - 1) * columnHeight;
                var endX = (item.endX - 1) * columnWidth;
                var endY = (item.endY - 1) * columnHeight;
                var color = item.color;
                var canvasWidth = endX - startX;
                var canvasHeight = endY - startY;

                canvas.setAttribute('width', canvasWidth);
                canvas.setAttribute('height', canvasHeight);
                canvas.style.left = `${startX}px`;
                canvas.style.top = `${startY}px`;
                container.appendChild(canvas);
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            }
        },
        clear(container) {
            var items = $(container).find('.item');
            items.remove();
        },
    };

    var RoadCanvasManager = {
        draw(canvas, rows, cols, roads) {
            var ctx = canvas.getContext('2d');
            var width = canvas.width;
            var height = canvas.height;
            var columnWidth = width / cols;
            var columnHeight = height / rows;
            for (var road of roads) {
                var startX = (road[0] - 1) * columnWidth;
                var startY = (road[1] - 1) * columnHeight;
                ctx.fillRect(startX, startY, columnWidth, columnHeight);
            }
        },
    };

    var SaveManager = {
        init(data) {
            var container = document.getElementById('save');
            container.innerHTML = "";
            var index = 0;
            for (var item of data) {
                var road = item.road || [];
                var rooms = item.rooms || {};
                var wrap = document.createElement('div');
                var trigger = document.createElement('div');
                trigger.setAttribute('class', 'trigger');
                trigger.setAttribute('data-idx', index);
                wrap.appendChild(trigger);
                var backgroundCanvas = document.createElement('canvas');
                backgroundCanvas.setAttribute('class', 'background');
                var backgroundCtx = backgroundCanvas.getContext('2d');
                DrawCanvasManager.create(wrap, rooms, 200, 100, 40, 80);

                backgroundCanvas.setAttribute('width', 200);
                backgroundCanvas.setAttribute('height', 100);
                wrap.appendChild(backgroundCanvas);
                container.appendChild(wrap);
                BackgroundCanvasManager.create(backgroundCanvas, 40, 80);
                index += 1;
            }
        },
    };

    var SceneManager = {
        init() {
            var container = document.getElementById('wrap');
            var backgroundCanvas = document.getElementById('background');
            var drawCanvas = document.getElementById('draw');
            BackgroundCanvasManager.create(backgroundCanvas, 40, 80);
            DrawCanvasManager.init(drawCanvas, container, 40, 80);

            var select = document.getElementById('name');
            var index = select.selectedIndex;
            var name = select[index].innerText;
            var color = select[index].getAttribute('value');
            options.name = name;
            options.color = color;

            RoadCanvasManager.draw(document.getElementById('road'), 40, 80, currentMap.road);
            SaveManager.init(savedData);

            select.addEventListener('change', () => {
                var index = select.selectedIndex;
                var name = select[index].innerText;
                var color = select[index].getAttribute('value');
                options.name = name;
                options.color = color;
            })
        },
    };

    document.getElementById('saveButton').addEventListener('click', () => {
        savedData.push(currentMap.deepCopy());
        SaveManager.init(savedData);
    });

    document.getElementById('save').addEventListener('click', () => {
        var target = event.target;
        var classList = target.classList;
        if (classList.contains('trigger')) {
            var index = target.getAttribute('data-idx');
            var item = (savedData[index] || {}).deepCopy();
            var container = document.getElementById('wrap');
            var roadCanvas = document.getElementById('road');
            DrawCanvasManager.clear(container);
            currentMap = item;
            DrawCanvasManager.create(container, currentMap.rooms, 800, 400, 40, 80);
            RoadCanvasManager.draw(roadCanvas, 40, 80, currentMap.road);
        }
    });

    SceneManager.init();
    </script>
</body>
</html>